<canvas id="webgl-canvas" class="fixed top-0 left-0 w-full h-full z-10 pointer-events-none"
></canvas>

<script>
    import * as THREE from 'three';
    import gsap from 'gsap';
    import { ScrollTrigger } from 'gsap/ScrollTrigger';

    gsap.registerPlugin(ScrollTrigger);

    function initWebGL() {
        const canvas = document.querySelector('#webgl-canvas') as HTMLCanvasElement;
        const sectionFilosofia = document.querySelector('#filosofia');
        if (!canvas) return;

        const escena = new THREE.Scene();
        const camara = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camara.position.z = 5;

        const render = new THREE.WebGLRenderer({
            canvas,
            alpha: true,
            antialias: true,
        });
        render.setSize(window.innerWidth, window.innerHeight);
        render.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        const geometrico = new THREE.IcosahedronGeometry(2, 0);
        const material = new THREE.MeshPhysicalMaterial({
            color: 0xffd400,
            roughness: 0.2,
            metalness: 1.0,
            flatShading: true,
        });
        const mesh = new THREE.Mesh(geometrico, material);
        escena.add(mesh);

        escena.add(new THREE.AmbientLight(0xffffff, 1));
        const luzDir = new THREE.DirectionalLight(0xffffff, 3);
        luzDir.position.set(5, 5, 5);
        escena.add(luzDir);

        const bucle = () => {
            mesh.rotation.x += 0.002;
            mesh.rotation.y += 0.02;
            render.render(escena, camara);
            requestAnimationFrame(bucle);
        };
        bucle();

        ScrollTrigger.refresh();

        // 5. COREOGRAFÍA DE SCROLL (Paso a Paso)
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: 'main', 
                start: 'top top', 
                end: 'bottom bottom', 
                scrub: 1.5, 
                invalidateOnRefresh: true,
            },
        });

        tl.to(mesh.position, { x: -6, y: 1, z: -2, duration: 2 })
            .to(mesh.rotation, { x: Math.PI * 2, y: Math.PI, duration: 2 }, '<')
            .to(mesh.position, { x: 3, y: -1, z: 0, duration: 2 })
            .to(mesh.scale, { x: 0.5, y: 0.5, z: 0.5, duration: 2 }, '<');

        // 6. RESIZE
        window.addEventListener('resize', () => {
            camara.aspect = window.innerWidth / window.innerHeight;
            camara.updateProjectionMatrix();
            render.setSize(window.innerWidth, window.innerHeight);
        });
    }

    // Ejecución en Astro
    document.addEventListener('astro:page-load', () => {
        setTimeout(initWebGL, 100);
    });
</script>
