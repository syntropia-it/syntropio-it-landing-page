---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

// Obtener solo proyectos destacados
const proyectosDestacados = await getCollection('projects', ({ data }) => {
  return data.featured === true;
});

// Ordenar por año (más reciente primero)
proyectosDestacados.sort((a, b) => b.data.year - a.data.year);

// Limitar a 6 proyectos
const proyectosParaMostrar = proyectosDestacados.slice(0, 6);
---

<section 
  id="proyectos-preview"
  class="bg-black/60 relative z-30 border-t border-white/10 overflow-hidden py-24"
>
  <!-- Header fijo -->
  <div class="px-6 container mx-auto mb-12">
    <div class="flex justify-between items-end">
      <div>
        <span class="text-xs font-bold tracking-[0.3em] text-samana-gold uppercase block mb-4">
          Portfolio
        </span>
        <h2 class="text-4xl md:text-6xl font-bold text-white font-serif">
          Proyectos Destacados
        </h2>
        <p class="text-gray-400 max-w-md mt-4">
          Desliza para ver nuestras transformaciones más emblemáticas.
        </p>
      </div>

      <a 
        href="/proyectos"
        class="hidden md:inline-block border border-samana-1 text-samana-1 px-6 py-3 font-bold hover:bg-samana-1 hover:text-black transition-all hoverable"
        data-cta="view-all-projects"
      >
        Ver todos →
      </a>
    </div>
  </div>

  <!-- Track de proyectos (scroll horizontal) -->
  <div class="relative">
    <div 
      class="flex gap-[4vw] px-[10vw] w-max"
      data-projects-track
    >
      {proyectosParaMostrar.map((p, i) => (
        <article 
          class="relative w-[70vw] md:w-[28vw] h-[50vh] shrink-0 group hoverable"
          data-project-card={i}
        >
          <!-- Número grande de fondo -->
          <div 
            class="absolute -top-20 z-50 -left-15 text-[8rem] leading-none font-bold text-transparent opacity-20  font-serif pointer-events-none"
            style={`-webkit-text-stroke:2px #ffd700;`}
            aria-hidden="true"
          >
            {String(i + 1).padStart(2, '0')}
          </div>

          <!-- Link al proyecto -->
          <a 
            href={`/proyectos/${String(p.slug)}`}
            class="block w-full h-full"
            data-cta={`project-${p.slug}`}
          >
            <!-- Imagen -->
            <div class="w-full h-[85%] overflow-hidden relative z-10 border border-white/10 group-hover:border-samana-gold transition-colors duration-500">
              <Image
                    src={p.data.image}
                    alt={p.data.title}
                    width={1200}
                    height={800}
                    sizes="(min-width: 768px) 35vw, 60vw"
                    loading={i === 0 ? "eager" : "lazy"}
                    priority={i === 0}
                    class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"
                  />
            </div>

            <!-- Info -->
            <div class="mt-6 flex justify-between items-end">
              <div>
                <h3 class="text-xl md:text-2xl font-bold text-white group-hover:text-samana-gold transition-colors">
                  {p.data.title}
                </h3>
                <p class="text-xs font-mono text-gray-500 uppercase mt-2">
                  {p.data.category}
                </p>
              </div>
              <div class="text-samana-gold font-mono text-sm">
                {p.data.year}
              </div>
            </div>
          </a>
        </article>
      ))}
    </div>
  </div>

  <!-- CTA mobile -->
  <div class="md:hidden text-center mt-20 md:mt-12 px-6">
    <a 
      href="/proyectos"
      class="inline-block border border-samana-1 text-samana-1 px-6 py-3 font-bold hover:bg-samana-1 hover:text-black transition-all w-full max-w-sm"
    >
      Ver todos los proyectos →
    </a>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initHorizontalScroll() {
    const track = document.querySelector('[data-projects-track]');
    const section = document.querySelector('#proyectos-preview');

    if (!track || !section) return;

    const getScrollAmount = () => -(track.scrollWidth - window.innerWidth);

    const tween = gsap.to(track, {
      x: getScrollAmount,
      ease: 'none',
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: () => `+=${track.scrollWidth}`, 
        pin: true,
        scrub: 1,
        invalidateOnRefresh: true, 
      },
    });

    
    const images = track.querySelectorAll('img');
    images.forEach(img => {
      gsap.to(img, {
        x: -40, 
        ease: 'none',
        scrollTrigger: {
          trigger: img,
          containerAnimation: tween, 
          start: 'left right',
          end: 'right left',
          scrub: true,
        }
      });
    });
  }

  // Astro Lifecycle: Sincronizado con el Layout
  document.addEventListener('astro:page-load', initHorizontalScroll);
</script>

<style>
  /* Optimizaciones de rendimiento */
  #proyectos-preview {
    /* Evitamos layout shifts durante el pinning */
    will-change: transform;
  }

  [data-projects-track] {
    will-change: transform;
  }

  img {
    filter: grayscale(1);
    transform: translateZ(0); 
    transition: filter 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .group:hover img {
    filter: grayscale(0);
  }
</style>