---
// ContactForm.astro
---

<section id="contacto" class="min-h-screen bg-black text-white py-12 relative z-30 overflow-hidden">
    <div
        class="absolute bottom-0 left-0 w-full h-1/2 bg-linear-to-t from-amber-900/20 to-transparent pointer-events-none"
    >
    </div>

    <div class="container mx-auto px-6 grid md:grid-cols-2 gap-16 items-center relative z-10">
        <div class="contact-info">
            <span class="text-samana-1 font-mono tracking-[0.3em] text-xs uppercase italic"
                >Iniciar Transformación</span
            >
            <h2
                class="text-5xl md:text-7xl font-serif font-bold mt-6 mb-8 leading-[0.9] uppercase tracking-tighter"
            >
                Tu Visión.<br />
                <span class="text-samana-1 italic">Nuestra Maestría.</span>
            </h2>
            <p class="text-gray-200 max-w-md mb-12 font-light leading-relaxed">
                Personalizamos cada detalle para plasmar tu proyecto de vida en tu hogar ideal.
                Nuestro equipo certificado brinda una solución integral para cada cliente[cite: 11].
            </p>

            <div class="flex flex-col items-center gap-6 max-w-xs">
                <span
                    id="step-label"
                    class="text-lg uppercase tracking-[0.4em] text-samana-1/60 font-mono "
                    >Preparando...</span
                >
                <div class="relative w-full z-60 h-1 bg-white/10 overflow-hidden rounded-full">
                    <div
                        id="progress-bar-line"
                        class="absolute top-0 left-0 h-full w-0 bg-samana-1 shadow-[0_0_15px_rgba(255,215,0,0.5)] transition-all"
                    >
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex gap-2">
                        {
                            [1, 2, 3, 4].map(i => (
                                <div
                                    data-step-indicator={i}
                                    class="h-6px w-6px border border-white/20 rounded-full transition-all duration-500"
                                />
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>

        <div
            class="form-card bg-neutral-900/40 backdrop-blur-2xl border border-white/5 p-8 md:p-12 shadow-2xl min-h-550px flex flex-col justify-center relative overflow-hidden group"
        >
            <form id="samana-form" data-current-step="1" class="relative">
                <div class="step-content" data-step="1">
                    <h3 class="text-2xl font-bold mb-8 text-white uppercase tracking-tight">
                        ¿Qué solución requieres?
                    </h3>
                    <div class="grid gap-3">
                        {
                            [
                                'Reformas Integrales',
                                'Proyectos Inmobiliarios',
                                'Diseño y Renderizado',
                                'Provisión de Materiales',
                            ].map(opt => (
                                <button
                                    type="button"
                                    data-value={opt}
                                    data-key="type"
                                    class="form-option group border border-white/5 p-5 hover:bg-white/5 text-left transition-all border-l-2 border-l-transparent hover:border-l-samana-1 translate-x-0"
                                >
                                    <span class="text-sm tracking-widest uppercase text-gray-400 group-hover:text-white transition-colors">
                                        {opt}
                                    </span>
                                </button>
                            ))
                        }
                    </div>
                </div>

                <div class="step-content hidden" data-step="2">
                    <button
                        type="button"
                        class="prev-step text-[10px] tracking-widest text-gray-500 hover:text-samana-1 mb-8 uppercase flex items-center gap-2 transition-colors"
                    >
                        <span class="text-lg">←</span> Volver
                    </button>
                    <h3 class="text-2xl font-bold mb-8 text-white uppercase tracking-tight">
                        Tipo de Propiedad
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        {
                            ['Casa', 'Departamento', 'Oficina', 'Local'].map(prop => (
                                <button
                                    type="button"
                                    data-value={prop}
                                    data-key="property"
                                    class="form-option border border-white/5 p-8 hover:bg-white/5 flex flex-col items-center gap-4 transition-all group"
                                >
                                    <span class="text-xs tracking-widest uppercase text-gray-400 group-hover:text-white">
                                        {prop}
                                    </span>
                                </button>
                            ))
                        }
                    </div>
                </div>

                <div class="step-content hidden" data-step="3">
                    <button
                        type="button"
                        class="prev-step text-[10px] tracking-widest text-gray-500 hover:text-samana-1 mb-8 uppercase flex items-center gap-2"
                    >
                        <span class="text-lg">←</span> Volver
                    </button>
                    <h3
                        class="text-2xl font-bold mb-8 text-white uppercase tracking-tight text-area-title"
                    >
                        Área a Intervenir
                    </h3>
                    <div id="area-options" class="grid gap-3"></div>
                </div>

                <div class="step-content hidden" data-step="4">
                    <button
                        type="button"
                        class="prev-step text-[10px] tracking-widest text-gray-500 hover:text-samana-1 mb-8 uppercase flex items-center gap-2"
                    >
                        <span class="text-lg">←</span> Volver
                    </button>
                    <h3 class="text-2xl font-bold mb-8 text-white uppercase tracking-tight">
                        Detalles Finales
                    </h3>
                    <div class="space-y-4">
                        <div class="relative">
                            <input
                                type="text"
                                name="name"
                                required
                                placeholder="NOMBRE COMPLETO"
                                class="form-input focus:outline-none focus:ring-0 w-full p-2 peer"
                            />
                            <div
                                class="absolute bottom-0 left-0 w-0 h-1px bg-samana-1 transition-all duration-500 peer-focus:w-full"
                            >
                            </div>
                        </div>
                        <div class="relative">
                            <input
                                type="email"
                                name="email"
                                required
                                placeholder="EMAIL DE CONTACTO"
                                class="form-input w-full focus:outline-none focus:ring-0 p-2 peer"
                            />
                            <div
                                class="absolute bottom-0 left-0 w-0 h-1px bg-samana-1 transition-all duration-500 peer-focus:w-full"
                            >
                            </div>
                        </div>
                        <textarea
                            name="vision"
                            placeholder="CUÉNTANOS TU VISIÓN..."
                            class="form-input h-32 w-full p-2 resize-none"></textarea>
                        <button
                            type="submit"
                            class="w-full bg-samana-1 text-black font-bold py-5 mt-6 tracking-[0.2em] uppercase hover:bg-white transition-all duration-500 shadow-lg shadow-samana-1/10"
                        >
                            Enviar Proyecto
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        import gsap from 'gsap';

        interface SamanaData {
            type: string;
            property: string;
            area: string;
            [key: string]: string;
        }

        class SamanaForm {
            private form: HTMLFormElement | null;
            private steps: NodeListOf<HTMLElement>;
            private indicators: NodeListOf<HTMLElement>;
            private label: HTMLElement | null;
            private progressBar: HTMLElement | null;
            private formData: SamanaData;
            private currentStep: number;
            private areaOpts: Record<string, string[]>;
            private stepLabels: string[] = ['Servicio', 'Propiedad', 'Área', 'Contacto'];

            constructor() {
                this.form = document.getElementById('samana-form') as HTMLFormElement;
                this.steps = document.querySelectorAll('.step-content');
                this.indicators = document.querySelectorAll('[data-step-indicator]');
                this.progressBar = document.getElementById('progress-bar-line');
                this.label = document.getElementById('step-label');
                this.formData = { type: '', property: '', area: '' };
                this.currentStep = 1;

                this.areaOpts = {
                    Casa: ['Baño Principal', 'Cocina Integral', 'Jardín / Exterior', 'Fachada'],
                    Departamento: ['Baño', 'Cocina', 'Living Comedor', 'Integral'],
                    Oficina: ['Sala de Juntas', 'Recepción', 'Open Space'],
                    Local: ['Vidriera', 'Interior', 'Probadores'],
                };

                this.init();
            }

            private init(): void {
                if (!this.form) return;
                this.updateProgress();
                this.setupListeners();
            }

            private setupListeners(): void {
                // Click en opciones iniciales
                if (!this.form) return;
                document.querySelectorAll('.form-option').forEach(btn => {
                    const button = btn as HTMLButtonElement;
                    button.addEventListener('click', () => {
                        const key = button.dataset.key || '';
                        const value = button.dataset.value || '';
                        this.handleTransition(1, () => this.handleSelection(key, value));
                    });
                });

                // Botones de retroceso
                document.querySelectorAll('.prev-step').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.handleTransition(-1, () => this.goToStep(this.currentStep - 1));
                    });
                });

                this.form.addEventListener('submit', e => {
                    e.preventDefault();
                    this.handleSubmit(e);
                });
            }

            // Maneja la dirección de la animación (entrada/salida)
            private handleTransition(direction: number, callback: Function): void {
                const xOffset = direction > 0 ? -40 : 40;
                gsap.to(this.form, {
                    opacity: 0,
                    x: xOffset,
                    duration: 0.4,
                    ease: 'power2.in',
                    onComplete: () => {
                        callback();
                        gsap.fromTo(
                            this.form,
                            { opacity: 0, x: -xOffset },
                            { opacity: 1, x: 0, duration: 0.6, ease: 'power2.out' }
                        );
                    },
                });
            }

            private handleSelection(key: string, value: string): void {
                this.formData[key] = value;
                if (key === 'property') this.renderAreaOptions(value);
                this.goToStep(this.currentStep + 1);
            }

            private renderAreaOptions(property: string): void {
                const container = document.getElementById('area-options');
                if (!container) return;

                const options = this.areaOpts[property] || this.areaOpts['Casa'];
                container.innerHTML = options
                    .map(
                        opt => `
                <button type="button" data-value="${opt}" class="form-option-dynamic border border-white/5 p-5 hover:bg-white/5 text-left transition-all border-l-2 border-l-transparent hover:border-l-samana-1 uppercase text-[10px] tracking-widest text-gray-400 hover:text-white">
                    ${opt}
                </button>
            `
                    )
                    .join('');

                container.querySelectorAll('.form-option-dynamic').forEach(btn => {
                    const button = btn as HTMLButtonElement;
                    button.addEventListener('click', () => {
                        this.handleTransition(1, () => {
                            this.formData.area = button.dataset.value || '';
                            this.goToStep(this.currentStep + 1);
                        });
                    });
                });
            }

            private goToStep(step: number): void {
                this.steps.forEach(s => s.classList.add('hidden'));
                const next = document.querySelector(`[data-step="${step}"]`) as HTMLElement;
                if (next) {
                    next.classList.remove('hidden');
                    this.currentStep = step;
                    this.updateProgress();
                }
            }

            private updateProgress(): void {
                if (this.label)
                    this.label.innerText = `Paso ${this.currentStep}: ${this.stepLabels[this.currentStep - 1]}`;

                const progressPercentage =
                    ((this.currentStep - 1) / (this.indicators.length - 1)) * 100;
                gsap.to(this.progressBar, {
                    width: `${progressPercentage}%`,
                    duration: 0.8,
                    ease: 'expo.out',
                });

                this.indicators.forEach((ind, i) => {
                    const indicator = ind as HTMLElement;
                    const isActive = i + 1 <= this.currentStep;
                    gsap.to(indicator, {
                        backgroundColor: isActive ? '#FFD700' : 'rgba(255,255,255,0.1)',
                        scaleX: isActive ? 1.2 : 1,
                        duration: 0.8,
                        ease: 'expo.out',
                    });
                });
            }

            private async handleSubmit(e: Event): Promise<void> {
                e.preventDefault();
                const formElement = e.target as HTMLFormElement;
                const submitBtn = formElement.querySelector(
                    'button[type="submit"]'
                ) as HTMLButtonElement;

                // UI Feedback
                submitBtn.disabled = true;
                const originalText = submitBtn.innerText;
                submitBtn.innerText = 'PROCESANDO TU VISIÓN...';

                try {
                    // Aquí conectarías con tu endpoint de Formspree o Backend propio
                    const payload = {
                        ...this.formData,
                        ...Object.fromEntries(new FormData(formElement)),
                    };
                    console.log('Enviando a Samana:', payload);

                    // Simulación de delay de red para efecto estético
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    this.showSuccessState();
                } catch (error) {
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'ERROR - REINTENTAR';
                    gsap.to(submitBtn, { x: [-10, 10, -10, 10, 0], duration: 0.4 });
                }
            }

            private showSuccessState(): void {
                if (!this.form) return;

                gsap.to(this.form, {
                    opacity: 0,
                    scale: 0.9,
                    duration: 0.5,
                    onComplete: () => {
                        if (this.form) {
                            this.form.innerHTML = `
                            <div class="text-center py-12 animate-in fade-in zoom-in duration-700">
                                <span class="text-samana-1 text-6xl mb-6 block">✓</span>
                                <h3 class="text-xl lg:text-3xl font-serif font-bold mb-4 px-2 uppercase">Transformación Iniciada</h3>
                                <p class="text-gray-200 font-light leading-relaxed">
                                    Gracias por confiar en nuestra maestría. <br/>
                                    Un asesor se pondrá en contacto para plasmar tu hogar ideal.
                                </p>
                            </div>
                `;
                            gsap.to(this.form, { opacity: 1, scale: 1, duration: 0.5 });
                        }
                    },
                });
            }
        }

        document.addEventListener('astro:page-load', () => new SamanaForm());
    </script>

    <style>
        .form-input {
            @reference w-full bg-white/5 border-b border-white/10 p-5 focus:outline-none text-xs tracking-widest text-white placeholder-gray-700 transition-all uppercase;
        }
        .text-samana-gold {
            color: #ffd700;
        }
        .bg-samana-gold {
            background-color: #ffd700;
        }
        .border-l-samana-gold {
            border-left-color: #ffd700;
        }
        #progress-bar-line {
            will-change: width;
        }
    </style>
</section>
