---
// ContactForm.astro
---

<section
  id="contacto"
  class="min-h-screen bg-black text-white py-12 relative z-30 overflow-hidden"
>
  <div
    class="absolute bottom-0 left-0 w-full h-1/2 bg-linear-to-t from-amber-900/20 to-transparent pointer-events-none"
  >
  </div>

  <div
    class="container mx-auto px-6 grid md:grid-cols-2 gap-16 items-center relative z-10"
  >
    <div class="contact-info">
      <span
        class="text-samana-1 font-mono tracking-[0.3em] text-xs uppercase italic"
        >Iniciar Transformación</span
      >
      <h2
        class="text-5xl md:text-7xl font-serif font-bold mt-6 mb-8 leading-[0.9] uppercase tracking-tighter"
      >
        Tu Visión.<br />
        <span class="text-samana-1 italic">Nuestra Maestría.</span>
      </h2>
      <p class="text-gray-200 max-w-md mb-12 font-light leading-relaxed">
        Personalizamos cada detalle para plasmar tu proyecto de vida en tu hogar
        ideal. Nuestro equipo certificado brinda una solución integral para cada
        cliente.
      </p>

      <div class="flex flex-col items-center gap-6 max-w-xs">
        <span
          id="step-label"
          class="text-lg uppercase tracking-[0.4em] text-samana-1/60 font-mono"
          >Preparando...</span
        >
        <div
          class="relative w-full z-60 h-1 bg-white/10 overflow-hidden rounded-full"
        >
          <div
            id="progress-bar-line"
            class="absolute top-0 left-0 h-full w-0 bg-samana-1 shadow-[0_0_15px_rgba(255,215,0,0.5)] transition-all"
          >
          </div>
        </div>
        <div class="flex justify-between items-center">
          <div class="flex gap-2">
            {
              [1, 2, 3, 4].map((i) => (
                <div
                  data-step-indicator={i}
                  class="h-6px w-6px border border-white/20 rounded-full transition-all duration-500"
                />
              ))
            }
          </div>
        </div>
      </div>
    </div>

    <div
      class="form-card bg-neutral-900/40 backdrop-blur-2xl border border-white/5 p-8 md:p-12 shadow-2xl min-h-600px flex flex-col justify-center relative overflow-hidden group"
    >
      <form id="samana-form" class="relative">
        <div id="step-container"></div>
      </form>
    </div>
  </div>

  <script>
    import gsap from "gsap";

    // Definición de la estructura del árbol basada en el diagrama [cite: 1, 20]
    const FLOW_TREE = {
      start: {
        question: "¿QUÉ ESTÁS PENSANDO?", // [cite: 13]
        options: [
          {
            label: "QUIERO REMODELAR",
            next: "remodelar_tipo",
            value: "remodelar",
          }, //
          {
            label: "QUIERO CONSTRUIR",
            next: "construir_inicio",
            value: "construir",
          }, //
        ],
      },
      // RAMA REMODELAR
      remodelar_tipo: {
        question: "¿QUÉ TIPO DE PROPIEDAD NECESITAS REFORMAR?", //
        options: [
          {
            label: "DEPARTAMENTO",
            next: "remodelar_m2",
            value: "departamento",
          }, // [cite: 3]
          { label: "CASA", next: "remodelar_m2", value: "casa" }, // [cite: 4]
        ],
      },
      remodelar_m2: {
        question: "¿CUÁNTOS M2 TIENE LA PROPIEDAD?", // [cite: 7]
        options: [
          { label: "-100 m²", next: "zona", value: "-100" }, // [cite: 6]
          { label: "100 a 200 m²", next: "zona", value: "100-200" }, // [cite: 8]
          { label: "+200 m²", next: "zona", value: "+200" }, // [cite: 10]
        ],
      },
      // RAMA CONSTRUIR
      construir_inicio: {
        question: "CONTANOS", // [cite: 21]
        options: [
          {
            label: "YA TENGO TERRENO",
            next: "terreno_m2",
            value: "con_terreno",
          }, // [cite: 18]
          {
            label: "QUIERO COMPRAR",
            next: "terreno_m2_buscar",
            value: "buscar_terreno",
          }, // [cite: 22]
        ],
      },
      terreno_m2: {
        question: "¿CUÁNTOS M2 TIENE TU TERRENO?", // [cite: 19]
        options: [
          { label: "100 a 200 m²", next: "zona", value: "100-200" }, // [cite: 14]
          { label: "200 a 500 m²", next: "zona", value: "200-500" }, //
          { label: "+500 m²", next: "zona", value: "+500" }, // [cite: 25]
        ],
      },
      terreno_m2_buscar: {
        question: "¿DE CUÁNTOS M2 ESTÁS BUSCANDO?", // [cite: 23]
        options: [
          { label: "100 a 200 m²", next: "zona", value: "100-200" }, // [cite: 26]
          { label: "200 a 500 m²", next: "zona", value: "200-500" }, // [cite: 27]
          { label: "-500 m²", next: "zona", value: "-500" }, // [cite: 28]
        ],
      },
      // PASO FINAL COMÚN
      zona: {
        question: "¿EN QUÉ ZONA SE ENCUENTRA / TE INTERESA?", // [cite: 30, 31]
        isFinal: true,
      },
    };

    class SamanaForm {
      private container = document.getElementById("step-container");
      private progressBar = document.getElementById("progress-bar-line");
      private label = document.getElementById("step-label");
      private form = document.getElementById("samana-form") as HTMLFormElement;
      private history: string[] = ["start"];
      private formData: any = {};

      constructor() {
        this.init();
      }

      private init() {
        if (!this.form || !this.container) return;
        this.renderStep("start");

        this.form.addEventListener("submit", (e) => this.handleSubmit(e));
      }

      private renderStep(stepKey: string) {
        const step = (FLOW_TREE as any)[stepKey];
        if (!this.container) return;

        // Actualizar progreso (estimado 4 pasos)
        const progress = (this.history.length / 4) * 100;
        gsap.to(this.progressBar, { width: `${progress}%`, duration: 0.5 });
        if (this.label) this.label.innerText = `Paso ${this.history.length}`;

        let html = "";

        // Botón volver
        if (this.history.length > 1) {
          html += `<button type="button" id="prev-btn" class="text-[10px] tracking-widest text-gray-300 hover:text-samana-1 mb-8 uppercase flex items-center gap-2"><span class="text-lg">←</span> Volver</button>`;
        }

        html += `<h3 class="text-2xl font-bold mb-8 text-white uppercase tracking-tight">${step.question}</h3>`;

        if (step.isFinal) {
          html += this.renderFinalForm();
        } else {
          html += `<div class="grid gap-3">`;
          step.options.forEach((opt: any) => {
            html += `
            <button 
            type="button" 
            data-next="${opt.next}" 
            data-value="${opt.value}" 
            class="step-opt group border border-white/5 p-8 hover:bg-white/5 text-left transition-all border-l-2 border-l-transparent hover:border-l-samana-1"
            >
              <span 
              class="text-sm tracking-widest uppercase text-gray-400 group-hover:text-white"
              >${opt.label}</span>
            </button>`;
          });
          html += `</div>`;
        }

        this.container.innerHTML = html;
        this.setupListeners(stepKey);
      }

      private renderFinalForm() {
        return `
    <div class="space-y-6">
      <div class="relative group">
        <input 
          type="text" 
          name="zona" 
          required 
          placeholder="ZONA O BARRIO (EJM: NORDELTA)" 
          class="form-input w-full p-2 focus:outline-none bg-transparent peer" 
        />
        <div class="absolute bottom-0 left-0 w-0 h-[1px] bg-samana-1 transition-all duration-500 peer-focus:w-full"></div>
      </div>

      <div class="relative group">
        <input 
          type="text" 
          name="name" 
          required 
          placeholder="NOMBRE COMPLETO" 
          class="form-input w-full p-2 focus:outline-none bg-transparent peer" 
        />
        <div class="absolute bottom-0 left-0 w-0 h-[1px] bg-samana-1 transition-all duration-500 peer-focus:w-full"></div>
      </div>

      <div class="relative group">
        <input 
          type="email" 
          name="email" 
          required 
          placeholder="EMAIL DE CONTACTO" 
          class="form-input w-full p-2 focus:outline-none bg-transparent peer" 
        />
        <div class="absolute bottom-0 left-0 w-0 h-[1px] bg-samana-1 transition-all duration-500 peer-focus:w-full"></div>
      </div>

      <div class="relative group">
        <input 
          type="tel" 
          name="phone" 
          required 
          placeholder="TELÉFONO DE CONTACTO" 
          class="form-input w-full p-2 focus:outline-none bg-transparent peer" 
        />
        <div class="absolute bottom-0 left-0 w-0 h-[1px] bg-samana-1 transition-all duration-500 peer-focus:w-full"></div>
      </div>

      <div class="relative group">
        <textarea 
          name="vision" 
          placeholder="CUÉNTANOS TU VISIÓN..." 
          class="form-input h-32 w-full p-2 resize-none focus:outline-none bg-transparent peer"
        ></textarea>
        <div class="absolute bottom-0 left-0 w-0 h-[1px] bg-samana-1 transition-all duration-500 peer-focus:w-full"></div>
      </div>

      <button type="submit" class="w-full bg-samana-1 text-black font-bold py-5 mt-6 tracking-[0.2em] uppercase hover:bg-white transition-all duration-500 shadow-lg shadow-samana-1/10">
        Enviar Proyecto
      </button>
    </div>`;
      }

      private setupListeners(stepKey: string) {
        // Opciones
        this.container?.querySelectorAll(".step-opt").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const target = e.currentTarget as HTMLButtonElement;
            this.formData[stepKey] = target.dataset.value;
            this.history.push(target.dataset.next!);
            this.transition(() => this.renderStep(target.dataset.next!));
          });
        });

        // Volver
        document.getElementById("prev-btn")?.addEventListener("click", () => {
          this.history.pop();
          this.transition(() =>
            this.renderStep(this.history[this.history.length - 1]),
          );
        });

      }

      private transition(cb: Function) {
        gsap.to(this.container, {
          opacity: 0,
          x: -20,
          duration: 0.3,
          onComplete: () => {
            cb();
            gsap.to(this.container, { opacity: 1, x: 0, duration: 0.3 });
          },
        });
      }

      private async handleSubmit(e: Event) {
        e.preventDefault();
        const formElement = e.target as HTMLFormElement;
        const submitBtn = formElement.querySelector(
          'button[type="submit"]',
        ) as HTMLButtonElement;

        if (!submitBtn) return;

        submitBtn.disabled = true;
        submitBtn.innerText = "PROCESANDO TU VISIÓN...";
        try {
          const formData = new FormData(formElement);
          const payload = {
            ...this.formData,
            ...Object.fromEntries(formData),
          };

          if ((window as any).gtag) {
            (window as any).gtag("event", "form_submit", {
              form_name: "samana_contact",
              service_type: payload.type || "unknown",
              property_type: payload.property || "unknown",
              area_type: payload.area || "unknown",
              user_email: payload.email || "anonymous",
            });
          }

          const response = await fetch("https://formspree.io/f/mykdzvoy", {
            method: "POST",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (response.ok) {
            this.showSuccessState();
          } else {
            throw new Error("Error en la respuesta del servidor");
          }
        } catch (error) {
          console.error("Form submission error:", error);
          submitBtn.disabled = false;
          submitBtn.innerText = "ERROR - REINTENTAR";
          gsap.to(submitBtn, { x: [-10, 10, -10, 10, 0], duration: 0.4 });

          // Track form error in GA4
          if ((window as any).gtag) {
            (window as any).gtag("event", "form_error", {
              form_name: "samana_contact",
              error_message: error instanceof Error ? error.message : "unknown",
            });
          }
        }
      }

      private showSuccessState(): void {
        if (!this.form) return;

        gsap.to(this.form, {
          opacity: 0,
          scale: 0.9,
          duration: 0.5,
          onComplete: () => {
            if (this.form) {
              this.form.innerHTML = `
                            <div class="text-center py-12 animate-in fade-in zoom-in duration-700">
                                <span class="text-samana-1 text-6xl mb-6 block">✓</span>
                                <h3 class="text-xl lg:text-3xl font-serif font-bold mb-4 px-2 uppercase">Transformación Iniciada</h3>
                                <p class="text-gray-200 font-light leading-relaxed">
                                    Gracias por confiar en nuestra maestría. <br/>
                                    Un asesor se pondrá en contacto para plasmar tu hogar ideal.
                                </p>
                            </div>
                `;
              gsap.to(this.form, { opacity: 1, scale: 1, duration: 0.5 });
            }
          },
        });
      }
    }

    document.addEventListener("astro:page-load", () => new SamanaForm());
  </script>

  <style>
    .form-input {
      @reference w-full bg-white/5 border-b border-white/10 p-5 focus:outline-none text-xs tracking-widest text-white placeholder-gray-700 transition-all uppercase;
    }
    .text-samana-gold {
      color: #ffd700;
    }
    .bg-samana-gold {
      background-color: #ffd700;
    }
    .border-l-samana-gold {
      border-left-color: #ffd700;
    }
    #progress-bar-line {
      will-change: width;
    }
  </style>
</section>
