---
import { Image } from 'astro:assets';

const cycleData = [
    {
        id: '01',
        title: 'Diseño y Renderizado',
        desc: 'Asesoramiento en el diseño de los ambientes para que se adapten a tu estilo, ayudando a plasmar e imaginar la idea final.', // Basado en texto oficial [cite: 10]
        img: 'https://images.unsplash.com/photo-1600607686527-6fb886090705?q=80&w=2000&auto=format&fit=crop',
    },
    {
        id: '02',
        title: 'Reformas y Proyectos',
        desc: 'Planificación, dirección y ejecución de remodelaciones integrales con personal certificado y altamente capacitado.', // Basado en texto oficial [cite: 8, 11]
        img: 'https://images.unsplash.com/photo-1600210492486-724fe5c67fb0?q=80&w=2000&auto=format&fit=crop',
    },
    {
        id: '03',
        title: 'Provisión de Materiales',
        desc: 'Venta y suministro de materiales de primera línea con logística propia, mejorando los costos de tu refacción.', // Basado en texto oficial [cite: 9, 14]
        img: 'https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?q=80&w=2000&auto=format&fit=crop',
    },
];
---

<section id="ciclo-maestria" class="bg-linear-to-b via-neutral-900 from-black/40 to-zinc-950/60 relative z-30">
    <div class="relative w-full h-screen scroll-container">
        <div class="sticky top-0 h-screen w-full flex flex-col md:flex-row overflow-hidden">
            <div
                class="w-full md:w-1/2 h-full flex items-center justify-center  px-8 border-r border-white/5 z-20"
            >
                <div class="relative w-full max-w-lg h-64 text-wrapper">
                    {
                        cycleData.map((item, i) => (
                            <div
                                data-cycle-index={i}
                                class="cycle-text-item absolute top-0 left-0 w-full opacity-0 translate-y-8 transition-all duration-700 ease-out"
                            >
                                <span class="text-samana-1 tracking-[0.3em] text-xs font-mono uppercase italic">
                                    {item.id} / Solución Integral
                                </span>
                                <h3 class="text-4xl md:text-6xl font-bold mt-4 mb-6 font-serif uppercase leading-tight text-white">
                                    {item.title}
                                </h3>
                                <p class="text-gray-300 text-lg font-light leading-relaxed">
                                    {item.desc}
                                </p>
                            </div>
                        ))
                    }
                </div>
            </div>

            <div class="w-full md:w-1/2 h-full relative bg-black overflow-hidden">
                <div
                    class="absolute inset-0 bg-linear-to-r from-neutral-900 to-transparent z-10 pointer-events-none"
                >
                </div>
                {
                    cycleData.map((item, i) => (
                        <Image                            
                            src={`${item.img}&w=900&q=70&auto=format&fit=crop`}
                            alt={item.title}
                            width={900}
                            height={600}
                            format="webp"
                            quality="mid"
                            data-cycle-img={i}
                            class="cycle-img absolute inset-0 w-full h-full object-cover opacity-0 scale-110 transition-all duration-1000 ease-in-out will-change-transform"
                            loading={i === 0 ? 'eager' : 'lazy'}                           
                        />
                    ))
                }
            </div>
        </div>
    </div>
</section>

<script>
    import gsap from 'gsap';
    import { ScrollTrigger } from 'gsap/ScrollTrigger';

    gsap.registerPlugin(ScrollTrigger);

    function initCycleScroll() {
        const container = document.querySelector('.scroll-container');
        const section = document.querySelector('#ciclo-maestria');
        const textItems = gsap.utils.toArray('.cycle-text-item');
        const imgItems = gsap.utils.toArray('.cycle-img');

        if (!container || !section || !textItems.length) return;

        // Limpieza quirúrgica
        ScrollTrigger.getAll().forEach(st => {
            if (st.trigger === container) st.kill();
        });

        const totalItems = textItems.length;

        // Estado inicial explícito (nada al azar)
        gsap.set(textItems, { opacity: 0, y: 40 });
        gsap.set(imgItems, { opacity: 0, scale: 1.1 });

        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: container,
                start: 'top top',
                end: () => `+=${window.innerHeight * totalItems}`,
                scrub: true,
                pin: true,
                anticipatePin: 1,
            },
        });

        textItems.forEach((text, i) => {
            const img = imgItems[i];
            if (!text || !img) return;

            // ENTRADA
            tl.to(
                text,
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.2,
                    ease: 'power2.out',
                },
                i
            );

            tl.to(
                img,
                {
                    opacity: 0.6,
                    scale: 1,
                    duration: 0.2,
                    ease: 'power2.out',
                },
                i
            );

            // SALIDA (excepto el último)
            if (i < totalItems - 1) {
                tl.to(
                    text,
                    {
                        opacity: 0,
                        y: -40,
                        duration: 0.2,
                        ease: 'power2.in',
                    },
                    i + 0.7
                );

                tl.to(
                    img,
                    {
                        opacity: 0,
                        scale: 1.1,
                        duration: 0.2,
                        ease: 'power2.in',
                    },
                    i + 0.7
                );
            }
        });

        ScrollTrigger.refresh();
    }

    document.addEventListener('astro:page-load', () => {
        requestAnimationFrame(initCycleScroll);
    });
</script>

<style>
    .font-serif {
        font-family: 'Playfair Display', serif;
    }

    /* Optimización de hardware para animaciones fluidas */
    .cycle-text-item,
    .cycle-img {
        will-change: transform, opacity;
    }
</style>
