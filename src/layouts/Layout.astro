---
import { ClientRouter } from 'astro:transitions';
import CustomCursor from '../components/core/customCursor.astro';
import BtnWhatsApp from '../components/core/ButtonWhatsApp.astro'
import Navbar from '../components/layout/Navbar.astro';
import Footer from '../components/layout/Footer.astro';
import SEO from '../components/core/SEO.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
    image?: string;
    schemaType?: 'home' | 'projects' | 'service' | 'faq';
    canonical?: string;
    alternates?: Record<string, string>;
    additionalSchema?: Array<Record<string, any>>;
    ratings?: { ratingValue: number; ratingCount: number } | null;
}

const {
    title,
    description = 'Samana Transformaciones - Reformas integrales y construcci贸n de alta gama.',
    image = '/iso.png',
    schemaType = 'home',
    canonical,
    alternates,
    additionalSchema,
} = Astro.props;

// 1. Configuraci贸n de URLs seguras
const siteUrl = Astro.site?.origin ?? 'https://www.samanatransformaciones.com';
const canonicalURL = canonical ?? new URL(Astro.url.pathname, siteUrl).toString();

// 2. L贸gica de Ratings con tipado estricto
let ratingsProp = Astro.props.ratings;

if (!ratingsProp) {
    try {
        const [projects, services, blog] = await Promise.all([
            getCollection('projects'),
            getCollection('services'),
            getCollection('blog'),
        ]);

        const allEntries = [...projects, ...services, ...blog];

        // Extraemos ratings asegurando que existan en el esquema de content
        const numericRatings = allEntries
            .map(entry => (entry.data as { rating?: number }).rating)
            .filter((r): r is number => typeof r === 'number');

        if (numericRatings.length > 0) {
            const sum = numericRatings.reduce((acc, val) => acc + val, 0);
            ratingsProp = {
                ratingValue: Number((sum / numericRatings.length).toFixed(2)),
                ratingCount: numericRatings.length,
            };
        }
    } catch (error) {
        console.error('Error fetching ratings for SEO:', error);
    }
}
---

<!doctype html>
<html lang="es-AR" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" type="image/svg+xml" href="/iso.png" />
        <meta name="generator" content={Astro.generator} />

        <SEO
            title={title}
            description={description}
            image={image}
            schemaType={schemaType}
            canonical={canonicalURL}
            alternates={alternates}
            additionalSchema={additionalSchema}
            ratings={ratingsProp}
        />

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap"
            rel="stylesheet"
        />

        <ClientRouter />
    </head>

    <body
        class="bg-black min-h-screen text-white selection:bg-[rgb(255,215,0)] selection:text-black overflow-x-hidden"
    >
        <div
            class="fixed inset-0 z-9999 pointer-events-none opacity-[0.04] bg-repeat"
            style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.80%22 numOctaves=%224%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23n)%22/%3E%3C/svg%3E');"
        >
        </div>
        <Navbar />
        <slot />
        <Footer />

        <CustomCursor />
        <BtnWhatsApp/>
    </body><script>
        import Lenis from 'lenis';
        import gsap from 'gsap';
        import { ScrollTrigger } from 'gsap/ScrollTrigger';

        gsap.registerPlugin(ScrollTrigger);

        let lenis: Lenis | null = null;

        const initScroll = () => {
            // Limpieza de instancias previas para evitar memory leaks en View Transitions
            if (lenis) lenis.destroy();
            ScrollTrigger.getAll().forEach(t => t.kill());

            lenis = new Lenis({
                duration: 1.2,
                easing: t => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                smoothWheel: true,
                touchMultiplier: 0, // Optimizaci贸n Performance Mobile
            });

            lenis.on('scroll', ScrollTrigger.update);

            gsap.ticker.add(time => {
                lenis?.raf(time * 1000);
            });

            gsap.ticker.lagSmoothing(0);
            ScrollTrigger.refresh();
        };

        // Ciclo de vida de Astro View Transitions
        document.addEventListener('astro:page-load', initScroll);
        document.addEventListener('astro:before-swap', () => {
            lenis?.destroy();
        });
    </script>

    <style is:global>
        html.lenis {
            height: auto;
        }

        .lenis.lenis-smooth {
            scroll-behavior: auto !important;
        }

        .lenis.lenis-smooth [data-lenis-prevent] {
            overscroll-behavior: contain;
        }

        .lenis.lenis-stopped {
            overflow: hidden;
        }

        .lenis.lenis-scrolling iframe {
            pointer-events: none;
        }

        html {
            scroll-behavior: auto !important;
        }

        .noise-overlay {
            will-change: transform;
            transform: translateZ(0);
        }
    </style>
</html>
