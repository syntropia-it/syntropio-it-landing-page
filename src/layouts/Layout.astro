---
import { ClientRouter } from "astro:transitions";
import CustomCursor from "../components/core/customCursor.astro";
import BtnWhatsApp from "../components/core/ButtonWhatsApp.astro";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import SEO from "../components/core/SEO.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
  image?: string;
  schemaType?: "home" | "projects" | "service" | "faq" | "blog";
  canonical?: string;
  alternates?: Record<string, string>;
  additionalSchema?: Array<Record<string, any>>;
  ratings?: { ratingValue: number; ratingCount: number } | null;
  // Blog-specific props
  publishDate?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description = "Samana Transformaciones - Reformas integrales y construcción de alta gama.",
  image = "/og-image.png",
  schemaType = "home",
  canonical,
  alternates,
  additionalSchema,
  publishDate,
  author,
  tags,
} = Astro.props;

// 1. Configuración de URLs seguras
const siteUrl = Astro.site?.origin ?? "https://www.samanatransformaciones.com";
const canonicalURL =
  canonical ?? new URL(Astro.url.pathname, siteUrl).toString();

// 2. Lógica de Ratings con tipado estricto
let ratingsProp = Astro.props.ratings;

if (!ratingsProp) {
  try {
    const [projects, services, blog] = await Promise.all([
      getCollection("projects"),
      getCollection("services"),
      getCollection("blog"),
    ]);

    const allEntries = [...projects, ...services, ...blog];

    // Extraemos ratings asegurando que existan en el esquema de content
    const numericRatings = allEntries
      .map((entry) => (entry.data as { rating?: number }).rating)
      .filter((r): r is number => typeof r === "number");

    if (numericRatings.length > 0) {
      const sum = numericRatings.reduce((acc, val) => acc + val, 0);
      ratingsProp = {
        ratingValue: Number((sum / numericRatings.length).toFixed(2)),
        ratingCount: numericRatings.length,
      };
    }
  } catch (error) {
    console.error("Error fetching ratings for SEO:", error);
  }
}
---

<!doctype html>
<html lang="es-AR" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/iso.png" />
    <link rel="apple-touch-icon" href="/iso.png" />
    <meta name="theme-color" content="#000000" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="generator" content={Astro.generator} />

    <SEO
      title={title}
      description={description}
      image={image}
      schemaType={schemaType}
      canonical={canonicalURL}
      alternates={alternates}
      additionalSchema={additionalSchema}
      ratings={ratingsProp}
      publishDate={publishDate}
      author={author}
      tags={tags}
    />

    <!-- Fonts (async loading para no bloquear LCP) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap"
      />
    </noscript>

    <ClientRouter />

    <!-- Page Transition Styles -->
    <style is:global>
      @keyframes page-fade-in {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes page-fade-out {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-8px); }
      }
      ::view-transition-old(main-content) {
        animation: page-fade-out 0.3s ease-in forwards;
      }
      ::view-transition-new(main-content) {
        animation: page-fade-in 0.4s ease-out 0.1s both;
      }
    </style>
  </head>

  <body
    class="bg-black min-h-screen text-white selection:bg-[rgb(255,215,0)] selection:text-black overflow-x-hidden"
  >
    <!-- Skip navigation for keyboard/screen reader users -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-99999 focus:bg-samana-1 focus:text-black focus:px-6 focus:py-3 focus:font-bold focus:text-sm focus:uppercase focus:tracking-wider"
    >
      Saltar al contenido
    </a>
    <!-- Loading screen (first visit only) -->
    <div
      id="loading-screen"
      class="fixed inset-0 z-99999 bg-black flex flex-col items-center justify-center pointer-events-none"
      style="display: none;"
    >
      <img src="/iso.png" alt="" class="w-16 h-16 mb-8 opacity-0" id="loading-logo" aria-hidden="true" />
      <div class="w-40 h-px bg-white/10 overflow-hidden">
        <div id="loading-bar" class="h-full w-0 bg-samana-1"></div>
      </div>
    </div>

    <div
      class="fixed inset-0 z-9999 pointer-events-none opacity-[0.04] bg-repeat"
      style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.80%22 numOctaves=%224%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23n)%22/%3E%3C/svg%3E');"
    >
    </div>
    <Navbar transition:persist />
    <div id="main-content" style="view-transition-name: main-content;">
      <slot />
    </div>
    <Footer transition:persist />

    <CustomCursor transition:persist />
    <BtnWhatsApp transition:persist />
  </body>
</html>

<script>
  import { initializeAnalytics } from "../scripts/analytics";

  document.addEventListener("astro:page-load", () => {
    initializeAnalytics(
      import.meta.env.PUBLIC_GA_ID || undefined,
      import.meta.env.PUBLIC_CLARITY_ID || undefined
    );
  });
</script><script>
  import Lenis from "lenis";
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  let lenis: Lenis | null = null;

  const initScroll = () => {
    // Restaurar el scroll arriba apenas cambia la página o se actualiza
    window.scrollTo(0, 0);

    // Limpieza de instancias previas para evitar memory leaks en View Transitions
    if (lenis) lenis.destroy();

    // Evaluar en cada navegación (no a nivel módulo) para que sea fresco
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // Solo inicializar Lenis en dispositivos con mouse (desktop)
    if (!isTouchDevice) {
      lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        smoothWheel: true,
        touchMultiplier: 0,
      });

      lenis.on("scroll", ScrollTrigger.update);

      gsap.ticker.add((time) => {
        lenis?.raf(time * 1000);
      });

      gsap.ticker.lagSmoothing(0);
    }

    ScrollTrigger.refresh();
  };

  // Ciclo de vida de Astro View Transitions
  document.addEventListener("astro:page-load", initScroll);
  document.addEventListener("astro:before-swap", () => {
    lenis?.destroy();
  });
</script>

<script>
  import { initAnimations } from "../scripts/animation";

  document.addEventListener("astro:page-load", () => {
    requestAnimationFrame(() => {
      initAnimations();
    });
  });
</script>

<script>
  import gsap from "gsap";

  // Loading screen — only on first visit per session
  function initLoadingScreen() {
    const screen = document.getElementById("loading-screen");
    const logo = document.getElementById("loading-logo");
    const bar = document.getElementById("loading-bar");
    
    if (!screen || !logo || !bar) return;
    if (sessionStorage.getItem("samana-loaded")) {
      screen.style.display = "none";
      return;
    }

    screen.style.display = "flex";
    document.body.style.overflow = "hidden";

    const tl = gsap.timeline({
      onComplete: () => {
        gsap.to(screen, {
          opacity: 0,
          duration: 0.6,
          ease: "power2.inOut",
          onComplete: () => {
            screen.style.display = "none";
            document.body.style.overflow = "";
            sessionStorage.setItem("samana-loaded", "true");
          },
        });
      },
    });

    tl.to(logo, { opacity: 1, duration: 0.5, ease: "power2.out" })
      .to(bar, { width: "100%", duration: 1.2, ease: "power2.inOut" }, "-=0.2")
      .to(logo, { opacity: 0, duration: 0.3 }, "-=0.3");
  }

  document.addEventListener("astro:page-load", initLoadingScreen);
</script>
