---
import { ClientRouter } from "astro:transitions";
import CustomCursor from "../components/core/customCursor.astro";
import Navbar from "../components/layout/Navbar.astro";
import "../styles/global.css";
import Footer from "../components/layout/Footer.astro";
import SEO from "../components/core/SEO.astro";
import { getCollection } from "astro:content";

interface Props {
  title: string;
  description?: string;
  image?: string;
  schemaType?: "home" | "projects" | "service" | "faq";
  canonical?: string;
  alternates?: Record<string, string>;
  additionalSchema?: Array<Record<string, any>>;
  ratings?: { ratingValue: number; ratingCount: number } | null;
}

const {
  title,
  description = "Samana Transformaciones - Reformas integrales y construcción de alta gama.",
  image = "/iso.png",
  schemaType = "home",
} = Astro.props;
const siteUrl = Astro.site ?? new URL("https://www.samanatransformaciones.com");
const canonicalProp = (Astro.props as any).canonical as string | undefined;
const alternatesProp = (Astro.props as any).alternates as
  | Record<string, string>
  | undefined;
const additionalSchemaProp = (Astro.props as any).additionalSchema as
  | Array<Record<string, any>>
  | undefined;
let ratingsProp = (Astro.props as any).ratings as
  | { ratingValue: number; ratingCount: number }
  | undefined;

if (!ratingsProp) {
  try {
    const projects = await getCollection("projects");
    const services = await getCollection("services");
    const blog = await getCollection("blog");
    const all = [...projects, ...services, ...blog];
    const numericRatings = all
      .map((i) => (i.data as any).rating)
      .filter((r) => typeof r === "number");
    if (numericRatings.length > 0) {
      const sum = numericRatings.reduce((s: number, v: number) => s + v, 0);
      const avg = sum / numericRatings.length;
      ratingsProp = {
        ratingValue: Number(avg.toFixed(2)),
        ratingCount: numericRatings.length,
      };
    }
  } catch (e) {
    // ignore: collections may not exist or have rating fields
  }
}
const canonicalURL =
  canonicalProp ?? new URL(Astro.url.pathname, siteUrl).toString();
---

<!doctype html>
<html lang="es-AR" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/iso.png" />
    <meta name="generator" content={Astro.generator} />

    <SEO
      title={title}
      description={description}
      image={image}
      schemaType={schemaType}
      canonical={canonicalURL}
      alternates={alternatesProp}
      additionalSchema={additionalSchemaProp}
      ratings={ratingsProp}
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- Schema handled in SEO component -->

    <ClientRouter />
  </head>

  <body
    class="bg-black min-h-screen text-white selection:bg-[rgb(255,215,0)] selection:text-black overflow-x-hidden"
  >
    <div
      class="fixed inset-0 z-9000 pointer-events-none opacity-[0.07] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"
    >
    </div>
    <Navbar />
    <slot />
    <Footer />

    <CustomCursor />
  </body><script>
    import Lenis from "lenis";
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    let lenis: Lenis | null = null;

    function initScroll() {
      if (lenis) {
        lenis.destroy();
      }
      ScrollTrigger.getAll().forEach((t) => t.kill());

      lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        orientation: "vertical",
        gestureOrientation: "vertical",
        smoothWheel: true,
        // No suavizamos en táctil para mantener el 100/100 en Mobile Performance
        touchMultiplier: 0,
      });

      lenis.on("scroll", ScrollTrigger.update);

      gsap.ticker.add((time) => {
        lenis?.raf(time * 1000);
      });

      gsap.ticker.lagSmoothing(0);

      ScrollTrigger.refresh();
    }

    document.addEventListener("astro:page-load", initScroll);

    document.addEventListener("astro:before-swap", () => {
      if (lenis) {
        lenis.destroy();
        lenis = null;
      }
    });
  </script>

  <style is:global>
    html.lenis {
      height: auto;
    }

    .lenis.lenis-smooth {
      scroll-behavior: auto !important;
    }

    .lenis.lenis-smooth [data-lenis-prevent] {
      overscroll-behavior: contain;
    }

    .lenis.lenis-stopped {
      overflow: hidden;
    }

    .lenis.lenis-scrolling iframe {
      pointer-events: none;
    }

    html {
      scroll-behavior: auto !important;
    }

    .noise-overlay {
      will-change: transform;
      transform: translateZ(0);
    }
  </style>
</html>
