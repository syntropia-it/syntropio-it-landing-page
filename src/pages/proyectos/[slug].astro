---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/Layout.astro';
import ProjectHero from '../../components/sections/project/ProjectHero.astro';
import ProjectContent from '../../components/sections/project/ProjectContent.astro';
import FinalCTA from '../../components/shared/FinalCTA.astro';

export async function getStaticPaths() {
    const proyectos = await getCollection('projects');
    return proyectos.map(proyecto => ({
        params: { slug: proyecto.slug },
        props: { proyecto },
    }));
}

interface Props {
    proyecto: CollectionEntry<'projects'>;
}

const { proyecto } = Astro.props;
const { Content } = await proyecto.render();
const { title, description, year, image, location, area, client } = proyecto.data;

// URLs y SEO
const site = Astro.site?.origin ?? 'https://www.samanatransformaciones.com';
const canonicalURL = new URL(`/proyectos/${proyecto.slug}`, site).toString();

// Esquemas JSON-LD
const breadcrumbSchema = {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Inicio', item: site },
        { '@type': 'ListItem', position: 2, name: 'Proyectos', item: `${site}/proyectos` },
        { '@type': 'ListItem', position: 3, name: title, item: canonicalURL },
    ],
};

const reviewSchema = client
    ? {
          '@context': 'https://schema.org',
          '@type': 'Review',
          author: { '@type': 'Person', name: client },
          itemReviewed: { '@type': 'CreativeWork', name: title },
          reviewBody: description,
          reviewRating: { '@type': 'Rating', ratingValue: '5' },
      }
    : null;

const additionalSchema = [breadcrumbSchema, ...(reviewSchema ? [reviewSchema] : [])];
---

<BaseLayout
    title={`${title} — Samana`}
    description={description}
    schemaType="projects"
    canonical={canonicalURL}
    additionalSchema={additionalSchema}
>
    <main class="bg-linear-to-b from-transparent to-black text-white">
        <ProjectHero
            title={title}
            description={description}
            location={location}
            year={year}
            area={area}
            image={image}
        />

        <ProjectContent>
            <Content />
        </ProjectContent>

        <section class="relative">
            <FinalCTA
                title="¿Querés transformar tu espacio?"
                paragraph="Contanos tu idea y te asesoramos sin compromiso."
                buttonText="Hablemos de tu proyecto"
                buttonLink="/contacto"
            />
            <span class="absolute top-0 left-0 text-[20vw] font-serif font-black text-white/3 leading-none select-none pointer-events-none">
                {year}
            </span>
        </section>
    </main>
</BaseLayout>

<!-- GSAP: Parallax hero + Prose reveals (Lenis lo maneja Layout.astro) -->
<script>
    import { gsap } from 'gsap';
    import { ScrollTrigger } from 'gsap/ScrollTrigger';

    gsap.registerPlugin(ScrollTrigger);

    let localTriggers: globalThis.ScrollTrigger[] = [];

    function cleanupLocal() {
        localTriggers.forEach(t => t.kill());
        localTriggers = [];
    }

    function initHeroParallax() {
        const hero = document.querySelector('[data-hero]');
        const image = document.getElementById('hero-parallax-img');
        if (!hero || !image) return;

        gsap.set(image, { yPercent: -15 });

        const tween = gsap.to(image, {
            yPercent: 15,
            ease: 'none',
            scrollTrigger: {
                trigger: hero,
                start: 'top top',
                end: 'bottom top',
                scrub: true,
            },
        });
        if (tween.scrollTrigger) localTriggers.push(tween.scrollTrigger);
    }

    function initScrollReveals() {
        document
            .querySelectorAll(
                '.prose-project h2, .prose-project h3, .prose-project p, .prose-project li, .prose-project blockquote'
            )
            .forEach(el => {
                gsap.set(el, { y: 50, opacity: 0 });
                const tween = gsap.to(el, {
                    y: 0,
                    opacity: 1,
                    duration: 1,
                    ease: 'power3.out',
                    scrollTrigger: {
                        trigger: el,
                        start: 'top 90%',
                        toggleActions: 'play none none none',
                    },
                });
                if (tween.scrollTrigger) localTriggers.push(tween.scrollTrigger);
            });

        document.querySelectorAll('.prose-project img').forEach(img => {
            gsap.set(img, { scale: 1.1, opacity: 0, y: 30 });
            const tween = gsap.to(img, {
                scale: 1,
                opacity: 1,
                y: 0,
                duration: 1.5,
                ease: 'expo.out',
                scrollTrigger: {
                    trigger: img,
                    start: 'top 85%',
                },
            });
            if (tween.scrollTrigger) localTriggers.push(tween.scrollTrigger);
        });
    }

    document.addEventListener('astro:page-load', () => {
        cleanupLocal();
        initHeroParallax();
        initScrollReveals();
    });

    document.addEventListener('astro:before-swap', cleanupLocal);
</script>